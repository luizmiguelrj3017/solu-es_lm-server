<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Licenças - Ponto do Açaí</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    input, button { padding:10px; font-size:14px; }
    table { border-collapse: collapse; width: 100%; margin-top:16px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align:left; }
    th { background:#f3f3f3; }
    .badge { padding:4px 8px; border-radius: 10px; font-size:12px; display:inline-block; }
    .pending { background:#fff3cd; }
    .auth { background:#d1e7dd; }
    .rev { background:#f8d7da; }
    .muted { color:#666; }
    .btn { cursor:pointer; }
    .btn-ok { background:#198754; color:#fff; border:none; }
    .btn-bad { background:#dc3545; color:#fff; border:none; }
    .btn-blue { background:#0d6efd; color:#fff; border:none; }
    .small { font-size: 12px; }
    .err { color:#b02a37; margin-top:10px; }
    .ok { color:#146c43; margin-top:10px; }
  </style>
</head>
<body>
  <h2>Admin de Licenças</h2>
  <p class="muted">Use para autorizar/revogar máquinas por empresa.</p>

  <div class="row">
    <div>
      <label>URL do servidor</label><br/>
      <input id="baseUrl" style="width:340px" value="https://solu-es-lm-server.onrender.com" />
    </div>
    <div>
      <label>Admin Token</label><br/>
      <input id="token" style="width:220px" placeholder="luizmiguel_rj1411" />
    </div>
    <div>
      <label>Company Key</label><br/>
      <input id="company" style="width:220px" value="PONTO_DO_ACAI_001" />
    </div>
    <button class="btn btn-blue" onclick="loadDevices()">Carregar</button>
  </div>

  <div id="msg"></div>

  <table>
    <thead>
      <tr>
        <th>Hostname</th>
        <th>Device ID</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="4" class="muted">Clique em “Carregar”.</td></tr>
    </tbody>
  </table>

<script>
function badge(status) {
  const s = (status || '').toUpperCase();
  if (s.includes('PEND')) return `<span class="badge pending">PENDING</span>`;
  if (s.includes('AUTH') || s.includes('OK') || s.includes('TRUE')) return `<span class="badge auth">AUTHORIZED</span>`;
  if (s.includes('REV') || s.includes('BLOCK')) return `<span class="badge rev">REVOKED</span>`;
  return `<span class="badge">${status || '-'}</span>`;
}

function setMsg(html, kind="") {
  const el = document.getElementById("msg");
  el.className = kind;
  el.innerHTML = html ? `<p>${html}</p>` : "";
}

async function api(path, method="GET", body=null) {
  const base = document.getElementById("baseUrl").value.trim().replace(/\/+$/, "");
  const token = document.getElementById("token").value.trim();
  const headers = { "X-Admin-Token": token };
  if (body) headers["Content-Type"] = "application/json";
  const resp = await fetch(base + path, { method, headers, body: body ? JSON.stringify(body) : null });
  const txt = await resp.text();
  let data;
  try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
  if (!resp.ok) throw new Error(data.detail || data.error || txt);
  return data;
}

async function loadDevices() {
  setMsg("Carregando...", "muted");
  const company = document.getElementById("company").value.trim();
  try {
    const data = await api(`/admin/devices?company_key=${encodeURIComponent(company)}`);
    const arr = Array.isArray(data) ? data : (data.devices || []);
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";
    if (!arr.length) {
      tbody.innerHTML = `<tr><td colspan="4" class="muted">Nenhuma máquina encontrada.</td></tr>`;
      setMsg("OK. Nenhuma máquina encontrada.", "ok");
      return;
    }
    for (const d of arr) {
      const hostname = d.hostname || d.host || d.computer || "-";
      const deviceId = d.device_id || d.deviceId || d.id || "-";
      const status = d.status ?? d.authorized ?? d.ok ?? "-";
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${hostname}</td>
          <td><code>${deviceId}</code></td>
          <td>${badge(String(status))}</td>
          <td class="small">
            <button class="btn btn-ok" onclick="authorize('${company}','${deviceId}')">Autorizar</button>
            <button class="btn btn-bad" onclick="revoke('${company}','${deviceId}')">Revogar</button>
          </td>
        </tr>
      `);
    }
    setMsg("Lista carregada.", "ok");
  } catch (e) {
    setMsg("Erro: " + e.message, "err");
    document.getElementById("tbody").innerHTML = `<tr><td colspan="4" class="err">Erro ao carregar.</td></tr>`;
  }
}

async function authorize(company, device_id) {
  try {
    await api("/admin/device/authorize", "POST", { company_key: company, device_id });
    setMsg("Autorizado com sucesso ✅", "ok");
    loadDevices();
  } catch (e) {
    setMsg("Erro ao autorizar: " + e.message, "err");
  }
}

async function revoke(company, device_id) {
  try {
    await api("/admin/device/revoke", "POST", { company_key: company, device_id });
    setMsg("Revogado com sucesso ✅", "ok");
    loadDevices();
  } catch (e) {
    setMsg("Erro ao revogar: " + e.message, "err");
  }
}
</script>
</body>
</html>
